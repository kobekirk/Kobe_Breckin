---
title: "NFL Project"
output: 
  flexdashboard::flex_dashboard:
runtime: shiny
---

```{r global, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(stringr)
library(rvest)
library(polite)
library(sf)
library(maps)
library(viridis)
library(leaflet)
library(htmltools)
library(janitor)
library(purrr)
library(ggrepel)
```

```{r, echo = FALSE}

full_table <- read.csv("mydata.csv")

full_table <- full_table |>
  mutate(
    indendend_air_yard = as.numeric(indendend_air_yard),
    pass_attempts = as.numeric(pass_attempts),
    rush_attempts = as.numeric(rush_attempts),
    points_scored = as.numeric(points_scored)
  ) |>
  mutate(
    air_yards_per_pa = indendend_air_yard / pass_attempts,
    points_per_pa = points_scored / pass_attempts,
    points_per_ra = points_scored / rush_attempts,
    wins   = as.numeric(str_extract(record, "^[0-9]+")),
    losses = as.numeric(str_extract(record, "(?<=-)[0-9]+")),
    win_percentage = wins / (wins + losses),
    wins_per_pa = wins / pass_attempts,
    wins_per_ra = wins / rush_attempts
  )
```

About
==========================

Column {data-width = 200}
-------------------------

Our sources of data come from Pro-Football-Reference.com, which is an online statistics database containing advanced, recent and historical data from NFL games and seasons. Within Pro-Football-Reference.com, we are extracting points scored, pass attempts, and rush attempts from the “Team Stats and Rankings” table, and record from the “Schedule & Game Results” table (ex. 2024 Patriots Statistics). We are also extracting intended air yards and on-target percentage from the “Advanced Passing” table and rushing yards before contact per rush attempt from the “Advanced Rushing” table (ex. 2024 Patriots Advanced Stats). Our final table from Mini-Project 2 is 160 rows (32 teams x 5 seasons) by 9 columns (the 7 underlined variables above, plus team and year). Some variables we have yet to generate from our final table from Mini-Project 2 are intended air yards per pass attempt (intended air yards / pass attempts), wins and losses (extracted from record variable, ex. 11-6 means wins = 11 and losses = 6), winning percentage (wins / (wins + losses)), points per pass attempt (points scored / pass attempts), points per rush attempt (points scored / rush attempts), wins per pass attempt (wins / pass attempts), and wins per rush attempt (wins / rush attempts).

One question we plan to address is: How does an NFL team’s total pass/rush attempts in a given season affect the amount of points that team scores in the season? Similarly, we also plan to address the question: How does an NFL team’s total pass/rush attempts in a given season affect the number of wins that team achieves in the season? While these are the two main questions we plan to answer and graphically depict, we will also answer a subset of questions with our interactive graphs. For example, using Graph 1 (see below), a user could answer the question: What NFL team had the most intended air yards per pass attempt in 2022, and how did that correlate to winning percentage? Using Graph 2 (see below), a user could answer the question: How did the Seattle Seahawks number of rushing attempts change over the past 5 seasons, and in turn, how did their number of wins achieved change each year? Using Graph 3 (see below), a user could answer the question: What NFL team had the highest on-target percentage in the 2023 season? Or, what NFL team had the most pass attempts in the 2021 season? Or, what NFL team had the least amount of wins in the 2024 NFL season? We are planning on using a quarto dashboard in qmd to create our shiny app, because we have gained the most experience working with quarto over the semester.



Our analysis
==========================

Column {data-width = 200}
-------------------------

```{r}



```




Interactive EDA Models
==========================

Column {data-width = 200}
-------------------------


```{r, echo = FALSE}

nfl_colors <- c(
  CRD = "#97233F",  # Cardinals
  ATL = "#A71930",  # Falcons
  RAV = "#241773",  # Ravens
  BUF = "#00338D",  # Bills
  CAR = "#0085CA",  # Panthers
  CHI = "#0B162A",  # Bears
  CIN = "#FB4F14",  # Bengals
  CLE = "#311D00",  # Browns
  DAL = "#003594",  # Cowboys
  DEN = "#FB4F14",  # Broncos
  DET = "#0076B6",  # Lions
  GNB = "#203731",  # Packers
  HTX = "#03202F",  # Texans
  CLT = "#002C5F",  # Colts
  JAX = "#006778",  # Jaguars
  KAN = "#E31837",  # Chiefs
  RAI = "#000000",  # Raiders
  SDG = "#0080C6",  # Chargers (legacy SDG)
  RAM = "#003594",  # Rams
  MIA = "#008E97",  # Dolphins
  MIN = "#4F2683",  # Vikings
  NWE = "#002244",  # Patriots
  NOR = "#D3BC8D",  # Saints
  NYG = "#0B2265",  # Giants
  NYJ = "#125740",  # Jets
  PHI = "#004C54",  # Eagles
  PIT = "#FFB612",  # Steelers
  SFO = "#AA0000",  # 49ers
  SEA = "#002244",  # Seahawks
  TAM = "#D50A0A",  # Buccaneers
  OTI = "#4B92DB",  # Titans
  WAS = "#5A1414"   # Commanders
)


metrics <- c(
  "pass_attempts",
  "rush_attempts",
  "on_target",
  "rush_before_contact",
  "points_scored",
  "air_yards_per_pa",
  "points_per_pa",
  "points_per_ra",
  "wins",
  "losses",
  "win_percentage",
  "wins_per_pa",
  "wins_per_ra"
)

selectInput(
  "metric",
  "Choose a metric for x-axis:",
  choices = metrics,
  selected = "pass_attempts",
  multiple = FALSE
)

renderPlot({ req(input$metric) 
 ggplot(full_table, aes(
  x = reorder(team, -.data[[input$metric]]),
  y = .data[[input$metric]],
  fill = team
)) +
  geom_col(alpha = 0.9) +
  scale_fill_manual(values = nfl_colors) +
  labs(
    x = "Team",
    y = input$metric,
    title = paste("NFL Team:", input$metric)
  ) +
  theme_minimal(base_size = 16) +
  theme(legend.position = "none")
})
```

```{r, echo = FALSE}
inputPanel(
  selectInput("year", "Select Year:", choices = sort(unique(full_table$year))))

renderPlot({

  req(input$year)

  # Filter to selected year and ensure one point per team
  df <- full_table %>%
    filter(year == input$year) %>%
    distinct(team, .keep_all = TRUE)  # team column contains 3-letter abbrevs

  # Compute league averages
  nfl_avg_pass <- mean(df$pass_attempts, na.rm = TRUE)
  nfl_avg_rush <- mean(df$rush_attempts, na.rm = TRUE)

  ggplot(df, aes(
    x = pass_attempts,
    y = rush_attempts,
    color = team
  )) +
    geom_point(size = 4) +
    geom_text_repel(aes(label = team),
                    nudge_y = 5,
                    size = 4,
                    fontface = "bold",
                    show.legend = FALSE) +
    # NFL average lines
    geom_vline(xintercept = nfl_avg_pass, linetype = "dashed", color = "black") +
    geom_hline(yintercept = nfl_avg_rush, linetype = "dashed", color = "black") +
    scale_color_manual(values = nfl_colors) +
    labs(
      x = "Pass Attempts",
      y = "Rush Attempts",
      title = paste("Offensive Play Tendencies —", input$year),
      subtitle = "NFL average indicated by the dashed lines"
    ) +
    theme_minimal(base_size = 15) +
    theme(legend.position = "none")  # hide legend

})
```

#```{r, echo = FALSE}

inputPanel(
  selectInput("year", "Select Year:", choices = sort(unique(full_table$year)))
)

renderPlot({
     if (input$play_check)
        ggplot(full_table, aes(x = pass_attempts, y = rush_attempts))  +
          geom_jitter(aes(color = team), size = 0.9, alpha = 0.4) +
          scale_color_manual(values=c("orange","blue", "black"))
     else if (!input$play_check)      
        ggplot(full_table, aes(x = pass_attempts, y = rush_attempts))  +
          geom_jitter(size = 0.9, alpha = 0.4) +
          scale_color_manual(values=c("orange","blue", "black"))
})
```
