---
title: "Mini Project 2"
author: "Breckin Hadley and Kobe Kirk"
format: pdf
editor: visual
---

```{r}
#| include: FALSE

library(tidyverse)
library(stringr)
library(rvest)
library(polite)
library(sf)
library(maps)
library(viridis)
library(leaflet)
library(htmltools)
library(janitor)
library(purrr)
```

One team function

```{r}

safe_get <- function(page, css_selector, index = 1) {
  vals <- page |>
    html_nodes(css_selector) |>
    html_text(trim = TRUE)
  
  if (length(vals) < index || length(vals) == 0) return(NA_character_)
  vals[index]
}

seahawks <- function(url) {
  Sys.sleep(2)
  session <- bow(url, force = TRUE)
  page <- scrape(session)

  team <- "SEA"
  pass_attempts <- safe_get(page, "tfoot .right:nth-child(8)")
  rush_attempts <- safe_get(page, "#adv_rushing tfoot .right:nth-child(7)")     
  indendend_air_yard <- safe_get(page, "tfoot .right:nth-child(9)")     
  on_target <- safe_get(page, "tfoot .right:nth-child(24)")
  rush_before_contact <- safe_get(page, "tfoot .right:nth-child(11)")
  win_pct <- 0.75   
  

  tibble(
    team,
    pass_attempts,
    rush_attempts,
    indendend_air_yard,
    on_target,
    rush_before_contact,
    win_pct

  )
}

seahawks("https://www.pro-football-reference.com/teams/sea/2025_advanced.htm")




```

One Team Function 2
```{r}

safe_get <- function(page, css_selector, index = 1) {
  vals <- page |>
    html_nodes(css_selector) |>
    html_text(trim = TRUE)
  
  if (length(vals) < index || length(vals) == 0) return(NA_character_)
  vals[index]
}

seahawks2 <- function(url) {
  Sys.sleep(2)
  session <- bow(url, force = TRUE)
  page <- scrape(session)

  team <- "SEA"
  record <- safe_get(page, "tfoot .left+ .right")
  points_scored <- safe_get(page, "tfoot .right:nth-child(9)")     
  

  tibble(
    team,
    record,
    points_scored
  )
}

seahawks2("https://www.pro-football-reference.com/teams/sea/2024/gamelog/")
```



For loop
```{r}
library(tidyverse)
library(glue)
library(rvest)
library(polite)

#Safe Git Function
safe_get <- function(page, css_selector, index = 1) {
  vals <- page |>
    html_nodes(css_selector) |>
    html_text(trim = TRUE)
  
  if (length(vals) < index || length(vals) == 0) return(NA_character_)
  vals[index]
}

# Stat Scraping fucntion
team_stats <- function(team_abbr, year = 2025) {
  url <- glue("https://www.pro-football-reference.com/teams/{team_abbr}/{year}_advanced.htm") |> as.character()

  Sys.sleep(2)
  session <- bow(url, force = TRUE)
  page <- scrape(session)

  html_raw <- as.character(page)
  page_fixed <- read_html(gsub("<!--|-->", "", html_raw))

  team <- toupper(team_abbr)
  pass_attempts <- safe_get(page_fixed, "tfoot .right:nth-child(8)")
  rush_attempts <- safe_get(page_fixed, "#adv_rushing tfoot .right:nth-child(7)")     
  indendend_air_yard <- safe_get(page_fixed, "tfoot .right:nth-child(9)")     
  on_target <- safe_get(page_fixed, "tfoot .right:nth-child(24)")
  rush_before_contact <- safe_get(page_fixed, "#adv_rushing tfoot .right:nth-child(11)")

  tibble(
    team,
    year,
    pass_attempts,
    rush_attempts,
    indendend_air_yard,
    on_target,
    rush_before_contact
  )
}

#Abbreviation list
nfl_teams <- c(
  "crd", "atl", "rav", "buf", "car", "chi", "cin", "cle",
  "dal", "den", "det", "gnb", "htx", "clt", "jax", "kan",
  "rai", "sdg", "ram", "mia", "min", "nwe", "nor", "nyg",
  "nyj", "phi", "pit", "sfo", "sea", "tam", "oti", "was"
)

# Table for years 2020-2024
years <- 2020:2024
teams <- nfl_teams

nfl_tbl <- expand_grid(team_abbr = teams, year = years) |>
  mutate(data = map2(team_abbr, year, team_stats)) |>
  pull(data) |>                  
  list_rbind()  

nfl_tbl

```


For loop 2
```{r}
safe_get <- function(page, css_selector, index = 1) {
  vals <- page |>
    html_nodes(css_selector) |>
    html_text(trim = TRUE)
  
  if (length(vals) < index || length(vals) == 0) return(NA_character_)
  vals[index]
}

team_stats2 <- function(team_abbr, year = 2024) {
  url <- glue("https://www.pro-football-reference.com/teams/{team_abbr}/{year}/gamelog/") |> as.character()

  Sys.sleep(2)
  session <- bow(url, force = TRUE)
  page <- scrape(session)

  html_raw <- as.character(page)
  page_fixed <- read_html(gsub("<!--|-->", "", html_raw))

  team <- toupper(team_abbr)
  record <- safe_get(page, "tfoot .left+ .right")
  points_scored <- safe_get(page, "tfoot .right:nth-child(9)")  

  tibble(
    team,
    record,
    points_scored
  )
}

nfl_teams <- c(
  "crd", "atl", "rav", "buf", "car", "chi", "cin", "cle",
  "dal", "den", "det", "gnb", "htx", "clt", "jax", "kan",
  "rai", "sdg", "ram", "mia", "min", "nwe", "nor", "nyg",
  "nyj", "phi", "pit", "sfo", "sea", "tam", "oti", "was"
)

years <- 2020:2024
teams <- nfl_teams

nfl_tbl2 <- expand_grid(team_abbr = teams, year = years) |>
  mutate(data = map2(team_abbr, year, team_stats2)) |>
  pull(data) |>
  list_rbind()

nfl_tbl2
```



```{r}
full_table <- left_join(nfl_tbl,nfl_tbl2, join_by(team))
full_table

```